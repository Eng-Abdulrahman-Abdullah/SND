import sqlite3
from datetime import datetime
from typing import Dict, Tuple, Any

from database import DB_PATH, get_last_event, get_low_risk_event_count, get_event_stats

# -------------------------------
# 1) دوال مساعدة عامة
# -------------------------------

def convert_city_to_region(city: str) -> str:
    """
    تحويل المدينة إلى منطقة رئيسية داخل المملكة.
    يمكنك لاحقاً توسيع القاموس ليشمل كل المدن والقرى.
    """
    c = (city or "").strip().lower()

    central = {"riyadh", "الرياض"}
    west = {"jeddah", "مكة", "makkah", "المدينة", "medina", "madinah", "جدة"}
    east = {"dammam", "الدمام", "khobar", "الخبر", "الظهران"}
    south = {"abha", "أبها", "جازان", "jazan", "نجران"}
    north = {"tabuk", "تبوك", "عرعر", "sakaka", "سكاكا", "حائل"}

    if c in central:
        return "central"
    if c in west:
        return "west"
    if c in east:
        return "east"
    if c in south:
        return "south"
    if c in north:
        return "north"
    return "unknown"


def get_time_window(hour: int) -> str:
    """
    تقسيم اليوم إلى نوافذ زمنية:
      - night: 00-05
      - morning: 06-11
      - afternoon: 12-17
      - evening: 18-23
    """
    if hour < 6:
        return "night"
    if hour < 12:
        return "morning"
    if hour < 18:
        return "afternoon"
    return "evening"


# -------------------------------
# 2) validate_event
# -------------------------------

def validate_event(data: Dict[str, Any]) -> Tuple[bool, str]:
    """
    التحقق من أن الطلب يحتوي على الحقول الأساسية وبصيغة صحيحة.
    """
    required = ["user_id", "device", "city", "service", "event_time"]
    for field in required:
        if field not in data:
            return False, f"Missing field: {field}"
        if isinstance(data[field], str) and not data[field].strip():
            return False, f"Empty field: {field}"

    # التحقق من صيغة الوقت
    try:
        # نقبل صيغة ISO مثل 2025-11-29T14:00:00
        datetime.fromisoformat(data["event_time"])
    except Exception:
        return False, "Invalid event_time format, expected ISO like 2025-11-29T14:00:00"

    return True, "ok"


# -------------------------------
# 3) normalize_event
# -------------------------------

def normalize_event(data: Dict[str, Any]) -> Dict[str, Any]:
    """
    تطبيع البيانات:
      - توحيد المدينة إلى lowercase
      - إضافة region
      - ضبط os / browser إلى قيم قياسية
    ملاحظة مهمة: لا نُضيف كائنات datetime داخل هذا القاموس
    حتى لا تسبب مشاكل في JSON.
    """
    cleaned = dict(data)  # نعمل نسخة

    # توحيد النصوص الأساسية
    cleaned["user_id"] = str(cleaned.get("user_id", "")).strip()
    cleaned["device"] = str(cleaned.get("device", "")).strip().lower()
    cleaned["city"] = str(cleaned.get("city", "")).strip().lower()
    cleaned["service"] = str(cleaned.get("service", "")).strip().lower()
    cleaned["event_time"] = str(cleaned.get("event_time", "")).strip()

    # نظام التشغيل
    os_val = str(cleaned.get("os", "other")).strip().lower()
    if os_val not in {"ios", "android", "windows", "macos", "linux"}:
        os_val = "other"
    cleaned["os"] = os_val

    # المتصفح
    browser_val = str(cleaned.get("browser", "other")).strip().lower()
    if browser_val not in {"safari", "chrome", "edge", "firefox"}:
        browser_val = "other"
    cleaned["browser"] = browser_val

    # المنطقة
    cleaned["region"] = convert_city_to_region(cleaned["city"])

    return cleaned


# -------------------------------
# 4) build_features
# -------------------------------

def build_features(data: Dict[str, Any]) -> Dict[str, Any]:
    """
    بناء الميزات السلوكية من الحدث الحالي + الأحداث السابقة في قاعدة البيانات.

    المتوقَّع إرجاعه (مثال):
    {
        "event_hour": 14,
        "day_of_week": 5,
        "is_weekend": 1,
        "time_window": "afternoon",
        "is_night": 0,
        "events_last_1h": 2,
        "events_last_24h": 10,
        "avg_daily_events": 1.2,
        "minutes_since_last_event": 30.5,
        "is_new_device": 0,
        "is_known_city": 1,
        "city_frequency": 0.8,
        "device_frequency": 0.9,
        "service_frequency": 0.5,
        "is_sensitive_service": 1,
        "is_new_user": 0,
    }
    """
    user_id = data["user_id"]
    device = data["device"]
    city = data["city"]
    service = data["service"]
    event_time_str = data["event_time"]

    event_dt = datetime.fromisoformat(event_time_str)
    event_hour = event_dt.hour
    day_of_week = event_dt.weekday()  # 0=Monday
    is_weekend = 1 if day_of_week in (4, 5) else 0  # مثلاً الجمعة+السبت
    time_window = get_time_window(event_hour)
    is_night = 1 if time_window == "night" else 0

    # --------- 1) معلومات من الأحداث السابقة (آخر حدث) ---------
    last_event = get_last_event(user_id)
    if last_event:
        last_time_str, last_device, last_city, last_ts_ms = last_event
        last_dt = datetime.fromisoformat(last_time_str)
        minutes_since_last = (event_dt - last_dt).total_seconds() / 60.0
        is_new_device = 1 if last_device != device else 0
        is_known_city = 1 if last_city == city else 0
    else:
        minutes_since_last = 9999.0
        is_new_device = 1
        is_known_city = 0

    minutes_since_last = max(minutes_since_last, 0.0)

    stats = get_event_stats(
        user_id=user_id,
        device=device,
        city=city,
        service=service,
        now_ts_ms=int(event_dt.timestamp() * 1000),
    )

    events_last_1h = stats.get("events_last_1h", 0)
    events_last_24h = stats.get("events_last_24h", 0)
    avg_daily_events = stats.get("avg_daily_events", 0.0)
    device_frequency = stats.get("device_frequency", 0.0)
    city_frequency = stats.get("city_frequency", 0.0)
    service_frequency = stats.get("service_frequency", 0.0)

    # --------- 2) إحصاءات من قاعدة البيانات ---------

    # تحويل الوقت الحالي إلى milliseconds لاستخدامه في الاستعلام
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()

    now_ts_ms = int(event_dt.timestamp() * 1000)

    # عدد الأحداث لآخر ساعة
    cur.execute(
        """
        SELECT COUNT(*) FROM events
        WHERE user_id = ?
        AND timestamp_ms >= ?
        """,
        (user_id, now_ts_ms - 3600 * 1000),
    )
    events_last_1h = cur.fetchone()[0]

    # عدد الأحداث لآخر 24 ساعة
    cur.execute(
        """
        SELECT COUNT(*) FROM events
        WHERE user_id = ?
        AND timestamp_ms >= ?
        """,
        (user_id, now_ts_ms - 24 * 3600 * 1000),
    )
    events_last_24h = cur.fetchone()[0]

    # إجمالي الأحداث لهذا المستخدم
    cur.execute(
        """
        SELECT COUNT(*) FROM events
        WHERE user_id = ?
        """,
        (user_id,),
    )
    total_events = cur.fetchone()[0]

    # عدد الأيام المختلفة التي نشط فيها المستخدم
    cur.execute(
        """
        SELECT COUNT(DISTINCT date(event_time)) 
        FROM events
        WHERE user_id = ?
        """,
        (user_id,),
    )
    active_days = cur.fetchone()[0] or 0

    if active_days > 0:
        avg_daily_events = total_events / active_days
    else:
        avg_daily_events = 0.0

    # تكرار المدينة / الجهاز / الخدمة بالنسبة لسجل المستخدم
    if total_events > 0:
        cur.execute(
            """
            SELECT COUNT(*) FROM events
            WHERE user_id = ? AND city = ?
            """,
            (user_id, city),
        )
        city_count = cur.fetchone()[0]

        cur.execute(
            """
            SELECT COUNT(*) FROM events
            WHERE user_id = ? AND device = ?
            """,
            (user_id, device),
        )
        device_count = cur.fetchone()[0]

        cur.execute(
            """
            SELECT COUNT(*) FROM events
            WHERE user_id = ? AND service = ?
            """,
            (user_id, service),
        )
        service_count = cur.fetchone()[0]

        city_frequency = city_count / total_events
        device_frequency = device_count / total_events
        service_frequency = service_count / total_events
    else:
        city_frequency = 0.0
        device_frequency = 0.0
        service_frequency = 0.0

    conn.close()

    # --------- 3) حساسية الخدمة ---------

    # --------- 4) حالة المستخدم الجديد (لمنع تسميم البصمة) ---------
    # -------- 3) تعريف الميزات السلوكية النهائية --------

    # الخدمات الحساسة (SMS, كلمة مرور, بيانات هوية, ... إلخ)0
    sensitive_services = [
        "change_mobile",
        "reset_password",
        "update_profile",
        "update_ID",
        "issue_document",
    ]
    is_sensitive_service = 1 if service in sensitive_services else 0

    # عدد الأحداث منخفضة المخاطر السابقة لهذا المستخدم
    previous_low_risk = get_low_risk_event_count(user_id)
    is_new_user = 1 if previous_low_risk == 0 else 0

    # قاموس الميزات الذي يذهب للـ model + rules
    features = {
        # سياق الوقت
        "event_hour": event_hour,
        "day_of_week": day_of_week,
        "is_weekend": is_weekend,
        "time_window": time_window,
        "is_night": is_night,

        # علاقة الحدث السابق بالحالي
        "minutes_since_last_event": minutes_since_last,
        "is_new_device": is_new_device,
        "is_known_city": is_known_city,

        # نشاط المستخدم في الفترات الزمنية
        "events_last_1h": events_last_1h,
        "events_last_24h": events_last_24h,
        "avg_daily_events": avg_daily_events,

        # تكرار المدينة / الجهاز / الخدمة
        "city_frequency": city_frequency,
        "device_frequency": device_frequency,
        "service_frequency": service_frequency,

        # حساسية الخدمة + حالة المستخدم
        "is_sensitive_service": is_sensitive_service,
        "is_new_user": is_new_user,
    }

    return features
